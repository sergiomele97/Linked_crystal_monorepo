name: deployServer_development

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    environment: development
    runs-on: self-hosted
    steps:
      # 1ï¸âƒ£ Limpiar permisos del workspace
      - name: Fix permissions
        run: |
          sudo chown -R $USER:$USER /home/sergio/actions-runner/_work || true
          sudo chmod -R u+rw /home/sergio/actions-runner/_work || true

      # ðŸ“¦ 2ï¸âƒ£ Clonar el repositorio
      - name: Checkout repository
        uses: actions/checkout@v4

      # ðŸ—ï¸ 3ï¸âƒ£ Instalar Go y habilitar cachÃ©
      - name: Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.25'
          cache-dependency-path: packages/server/go.sum 

      # âš¡ 4ï¸âƒ£ Cache adicional persistente (opcional)
      - name: Cache Go build
        uses: actions/cache@v3
        with:
          path: |
            ~/.cache/go-build
            ~/.local/share/go
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}

      # ðŸ§± 5ï¸âƒ£ Compilar el servidor
      - name: Build Go server
        working-directory: packages/server
        run: |
          GOMAXPROCS=1 go build -v -x -ldflags="-s -w" -o server .

      # ðŸ” 6ï¸âƒ£ Reiniciar el servicio systemd con STATIC_TOKEN
      - name: Restart WebSocket service
        env:
          STATIC_TOKEN: ${{ secrets.STATIC_TOKEN }}
        run: |
          echo "STATIC_TOKEN=${STATIC_TOKEN}" | sudo tee /etc/default/websocket-server > /dev/null
          sudo systemctl daemon-reload
          sudo systemctl restart websocket-server
          sudo systemctl status websocket-server --no-pager
