name: buildAPK_development

on:
  workflow_dispatch:  # Solo se puede lanzar manualmente

jobs:
  build:
    environment: development
    runs-on: ubuntu-latest
    container:
      image: kivy/buildozer:latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Restore Buildozer cache
      uses: actions/cache@v4
      with:
        path: |
          $HOME/.buildozer/android/platform/android-sdk
          $HOME/.buildozer/android/platform/android-ndk-r25b
          $HOME/.buildozer/android/platform/python-for-android
          $HOME/.buildozer/android/platform/build-arm64-v8a/build/other_builds
        key: ${{ runner.os }}-buildozer-${{ hashFiles('packages/app/APKbuilder/buildozer.spec') }}
        restore-keys: |
          ${{ runner.os }}-buildozer-

    - name: Build debug APK
      working-directory: packages/app/APKbuilder
      run: |
        buildozer android debug
      env:
        ANDROIDSDK: $HOME/.buildozer/android/platform/android-sdk
        ANDROIDNDK: $HOME/.buildozer/android/platform/android-ndk-r25b
        JAVA_HOME: /usr/lib/jvm/java-17-openjdk-amd64

    - name: Upload generated APK (debug)
      uses: actions/upload-artifact@v4
      with:
        name: app-debug-apk
        path: packages/app/APKbuilder/bin/*.apk
        retention-days: 5
        overwrite: true
