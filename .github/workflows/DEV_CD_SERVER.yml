name: DEV_CD_SERVER

on:
  workflow_dispatch:
  workflow_run:
    workflows: ["DEV_CI_SERVER"]
    types:
      - completed

jobs:
  build-and-deploy:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    environment: development
    runs-on: self-hosted
    steps:
      - name: Fix permissions
        run: |
          sudo chown -R $USER:$USER /home/sergio/actions-runner/_work || true
          sudo chmod -R u+rw /home/sergio/actions-runner/_work || true

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25'
          cache-dependency-path: Linked_crystal/server/src/go.sum 

      - name: Build Go server
        run: |
          GOMAXPROCS=1 make build-server

      - name: Deploy WebSocket service
        env:
          STATIC_TOKEN: ${{ secrets.STATIC_TOKEN }}
          SERVERS: ${{ vars.SERVERS }}
          PORT: ${{ vars.PORT }}
        run: |
          sudo tee /etc/default/websocket-server > /dev/null <<EOF
          STATIC_TOKEN=${STATIC_TOKEN}
          SERVERS=${SERVERS:-ws://localhost:8080/ws}
          PORT=${PORT:-8080}
          EOF

          WORKDIR="/home/sergio/actions-runner/_work/Linked_crystal_monorepo/Linked_crystal_monorepo/Linked_crystal/server"
          EXEC_START="$WORKDIR/server"

          sudo tee /etc/systemd/system/websocket-server.service > /dev/null <<SERVICE
          [Unit]
          Description=WebSocket Server (Dev)
          After=network.target

          [Service]
          Type=simple
          User=$USER
          WorkingDirectory=$WORKDIR
          ExecStart=$EXEC_START
          Restart=always
          EnvironmentFile=/etc/default/websocket-server

          [Install]
          WantedBy=multi-user.target
          SERVICE

          sudo systemctl daemon-reload
          sudo systemctl restart websocket-server
          sudo systemctl status websocket-server --no-pager

      - name: Verify Health (Dev)
        run: |
          echo "Checking health on http://localhost:${PORT:-8080}/health..."
          for i in {1..5}; do
            if curl -s http://localhost:${PORT:-8080}/health | grep -q '"status":"ok"'; then
              echo "✅ Health check passed!"
              exit 0
            fi
            echo "⚠️ Health check failed (attempt $i/5). Retrying in 2s..."
            sleep 2
          done
          echo "❌ Health check failed after 5 attempts."
          exit 1
