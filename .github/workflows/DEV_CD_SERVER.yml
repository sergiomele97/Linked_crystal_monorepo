name: CD_server_dev

on:
  workflow_run:
    workflows: ["CI_server_dev"]
    types:
      - completed

jobs:
  build-and-deploy:
    # Only run if the test workflow succeeded
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    environment: development
    runs-on: self-hosted
    steps:
      # 1ï¸âƒ£ Limpiar permisos del workspace
      - name: Fix permissions
        run: |
          sudo chown -R $USER:$USER /home/sergio/actions-runner/_work || true
          sudo chmod -R u+rw /home/sergio/actions-runner/_work || true

      # ðŸ“¦ 2ï¸âƒ£ Clonar el repositorio
      - name: Checkout repository
        uses: actions/checkout@v4

      # ðŸ—ï¸ 3ï¸âƒ£ Instalar Go y habilitar cachÃ©
      - name: Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.25'
          cache-dependency-path: Linked_crystal/server/src/go.sum 

      # âš¡ 4ï¸âƒ£ Cache adicional persistente (opcional)
      - name: Cache Go build
        uses: actions/cache@v3
        with:
          path: |
            ~/.cache/go-build
            ~/.local/share/go
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}

      # ðŸ§± 5ï¸âƒ£ Compilar el servidor
      - name: Build Go server
        working-directory: Linked_crystal/server/src
        run: |
          GOMAXPROCS=1 go build -v -x -ldflags="-s -w" -o ../server ./cmd/server

      # ðŸ” 6ï¸âƒ£ Configurar variables de entorno y reiniciar servicio systemd
      - name: Deploy WebSocket service
        env:
          STATIC_TOKEN: ${{ secrets.STATIC_TOKEN }}
          SERVERS: ${{ vars.SERVERS }}        # opcional
          PORT: ${{ vars.PORT }}              # opcional
        run: |
          # Crear/actualizar archivo de entorno para systemd
          sudo tee /etc/default/websocket-server > /dev/null <<EOF
          STATIC_TOKEN=${STATIC_TOKEN}
          SERVERS=${SERVERS:-ws://localhost:8080/ws}
          PORT=${PORT:-8080}
          EOF

          # Actualizar definiciÃ³n del servicio (por si cambia la ruta)
          # Asumimos que el runner corre en /home/sergio/actions-runner/_work/Linked_crystal_monorepo/Linked_crystal_monorepo
          # Ajustar rutas segÃºn el nombre real del directorio de trabajo del runner
          WORKDIR="/home/sergio/actions-runner/_work/Linked_crystal_monorepo/Linked_crystal_monorepo/Linked_crystal/server"
          EXEC_START="$WORKDIR/server"

          sudo tee /etc/systemd/system/websocket-server.service > /dev/null <<SERVICE
          [Unit]
          Description=WebSocket Server (Dev)
          After=network.target

          [Service]
          Type=simple
          User=$USER
          WorkingDirectory=$WORKDIR
          ExecStart=$EXEC_START
          Restart=always
          EnvironmentFile=/etc/default/websocket-server

          [Install]
          WantedBy=multi-user.target
          SERVICE

          # Recargar y reiniciar servicio systemd
          sudo systemctl daemon-reload
          sudo systemctl restart websocket-server
          sudo systemctl status websocket-server --no-pager
