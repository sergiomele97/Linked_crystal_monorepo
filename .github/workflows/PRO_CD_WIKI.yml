name: PRO_CD_WIKI

on:
  push:
    branches: [ "main" ]
    paths:
      - 'Linked_crystal/devex/docs/**'
      - '.github/workflows/PRO_CD_WIKI.yml'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  deploy-wiki:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Source
        uses: actions/checkout@v4

      - name: Upload to GitHub Wiki
        run: |
          # Configure Git
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          # Root of the workspace
          REPO_DIR=$(pwd)
          
          # Create a temp directory to clone the wiki repo
          WIKI_TEMP_DIR=$(mktemp -d)
          
          # URL of the wiki repo
          WIKI_URL="https://x-access-token:${{ github.token }}@github.com/${{ github.repository }}.wiki.git"
          
          echo "Checking if Wiki repository exists..."
          if ! git ls-remote "$WIKI_URL" &> /dev/null; then
            echo "::error::GitHub Wiki is not initialized. Please go to the Wiki tab on GitHub.com and create the first page manually."
            exit 1
          fi

          echo "Cloning wiki repository..."
          git clone "$WIKI_URL" "$WIKI_TEMP_DIR"
          
          echo "Debug: Source directory contents:"
          ls -R "$REPO_DIR/Linked_crystal/devex/docs"
          
          echo "Debug: Wiki directory contents (before sync):"
          ls -R "$WIKI_TEMP_DIR"

          echo "Syncing documentation..."
          # Clean existing files in wiki (except .git)
          find "$WIKI_TEMP_DIR" -maxdepth 1 -not -name '.git' -not -name '.' -exec rm -rf {} +
          
          # Copy new files from project docs
          cp -R "$REPO_DIR/Linked_crystal/devex/docs/." "$WIKI_TEMP_DIR/"
          
          cd "$WIKI_TEMP_DIR"
          
          if [[ -n "$(git status --porcelain)" ]]; then
            echo "Changes detected. Pushing to Wiki..."
            git add .
            git commit -m "Update Wiki from main: ${GITHUB_SHA::7}"
            git push "$WIKI_URL" HEAD:master || git push "$WIKI_URL" HEAD:main
          else
            echo "No changes in Wiki content."
          fi
