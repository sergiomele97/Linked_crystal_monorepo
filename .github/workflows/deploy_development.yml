name: Deploy WebSocket Server

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    environment: development
    runs-on: self-hosted
    steps:
      # 1Ô∏è‚É£ Limpiar permisos del workspace
      - name: Fix permissions
        run: |
          sudo chown -R $USER:$USER /home/sergio/actions-runner/_work || true
          sudo chmod -R u+rw /home/sergio/actions-runner/_work || true

      # üì¶ 2Ô∏è‚É£ Clonar el repositorio
      - name: Checkout repository
        uses: actions/checkout@v4

      # üèóÔ∏è 3Ô∏è‚É£ Instalar Go y habilitar cach√©
      - name: Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.25'
          cache-dependency-path: packages/server/go.sum 

      # ‚ö° 4Ô∏è‚É£ Cache adicional persistente (opcional, mejora tiempos)
      - name: Cache Go build
        uses: actions/cache@v3
        with:
          path: |
            ~/.cache/go-build
            ~/.local/share/go
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}

      # üß± 5Ô∏è‚É£ Compilar el servidor (limitando CPU y RAM)
      - name: Build Go server
        working-directory: packages/server
        run: |
          GOMAXPROCS=1 go build -v -x -ldflags="-s -w" -o server .

      # üîÅ 6Ô∏è‚É£ Reiniciar el servicio systemd
      - name: Restart WebSocket service
        run: |
          sudo systemctl restart websocket-server
          sudo systemctl status websocket-server --no-pager
